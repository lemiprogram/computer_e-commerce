{% extends "layout.html" %}

{% block content %}
<div class="min-h-screen bg-bg-100 p-8">
  <div class="max-w-7xl mx-auto bg-bg-300 shadow-xl rounded-2xl p-8">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-10">
      <h1 class="text-3xl font-bold text-primary-100">Seller Dashboard</h1>
      <a href="{% url 'sign_out' %}" 
         class="bg-accent-200 hover:bg-accent-100 text-white px-5 py-2 rounded-lg cursor-pointer">
        Logout
      </a>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
      <div class="bg-bg-200 p-6 rounded-xl text-center shadow">
        <h2 class="text-lg font-semibold text-text-100">Total Products</h2>
        <p class="text-3xl font-bold text-primary-100" id="product-count">0</p>
      </div>
      <div class="bg-bg-200 p-6 rounded-xl text-center shadow">
        <h2 class="text-lg font-semibold text-text-100">Orders</h2>
        <p class="text-3xl font-bold text-primary-100" id="order-count">0</p>
      </div>
      <div class="bg-bg-200 p-6 rounded-xl text-center shadow">
        <h2 class="text-lg font-semibold text-text-100">Pending Orders</h2>
        <p class="text-3xl font-bold text-primary-100" id="pendingOrder-count">0</p>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
      <a href="{% url 'add_product' %}" class="bg-primary-100 hover:bg-primary-200 text-white p-6 rounded-xl shadow-lg text-center cursor-pointer">
        ‚ûï Add Product
      </a>
      <a href="{% url 'manage_products' %}" class="bg-primary-200 hover:bg-primary-100 text-white p-6 rounded-xl shadow-lg text-center cursor-pointer">
        üì¶ Manage Products
      </a>
      <a href="{% url 'manage_orders' %}" class="bg-accent-200 hover:bg-accent-100 text-white p-6 rounded-xl shadow-lg text-center cursor-pointer">
        üõí Manage Orders
      </a>
      <a href="{% url 'seller_account' %}" class="bg-bg-200 hover:bg-bg-100 text-text-100 p-6 rounded-xl shadow-lg text-center cursor-pointer">
        ‚öôÔ∏è Account Settings
      </a>
    </div>

    <!-- Recent Orders -->
    <div class="bg-bg-200 p-6 rounded-xl shadow mb-10">
      <h2 class="text-xl font-bold text-text-100 mb-4">Recent Orders</h2>
      <table class="w-full text-left">
        <thead>
          <tr class="border-b border-bg-300 text-text-200">
            <th class="py-2">Order ID</th>
            <th class="py-2">Product</th>
            <th class="py-2">Quantity</th>
            <th class="py-2">Status</th>
            <th class="py-2">Date</th>
          </tr>
        </thead>
        <tbody id="recent-orders">
          <tr>
            <td colspan="5" class="text-center py-4 text-text-200">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Top Products -->
    <div class="bg-bg-200 p-6 rounded-xl shadow mb-10">
      <h2 class="text-xl font-bold text-text-100 mb-4">Top Selling Products</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="top-products">
        <p class="text-text-200">Loading...</p>
      </div>
    </div>

  </div>
</div>

<script>
(async () => {
    try {
        
        const user = await get_data(get_User_url)
        const sellers = await get_data(get_Sellers_url+0)
        const seller = sellers.filter(s=>s.user == user.id)[0]
        let products = await get_data(get_Products_url+0) || [];
        products = products.filter(p=>p.seller == seller.id)
        let orders = await get_data(get_Orders_url+0) || [];
        orders = orders.filter(o=>products.map(p=>p.id).includes(o.product))

        // Stats
        document.getElementById("product-count").innerText = products.length;
        document.getElementById("order-count").innerText = orders.length;
        document.getElementById("pendingOrder-count").innerText = orders.filter(o => o.status === "pending").length;

        // Recent Orders
        const ordersTable = document.getElementById("recent-orders");
        ordersTable.innerHTML = "";
        if (orders.length) {
            orders.slice(0, 3).forEach(o => {
                ordersTable.innerHTML += `
                  <tr class="border-b border-bg-300">
                    <td class="py-2">#${o.id}</td>
                    <td class="py-2">${products.find(p => p.id === o.product)?.name || "N/A"}</td>
                    <td class="py-2">${o.quantity}</td>
                    <td class="py-2"><span class="px-3 py-1 rounded-lg text-text-100">${o.status}</span></td>
                    <td class="py-2">${new Date(o.created_at).toLocaleDateString()}</td>
                  </tr>`;
            });
        } else {
            ordersTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-text-200">No recent orders</td></tr>`;
        }

        // Top Products
        const topProductsDiv = document.getElementById("top-products");
        topProductsDiv.innerHTML = "";
        if (products.length) {
            products.slice(0, 3).forEach(p => {
                topProductsDiv.innerHTML += `
                  <div class="bg-bg-300 rounded-lg shadow-lg p-4 text-center">
                    ${p.image ? `<img src="${p.image}" alt="${p.name}" class="w-full h-40 object-cover rounded-md mb-4">` : ""}
                    <h3 class="font-semibold text-text-100">${p.name}</h3>
                    <p class="text-text-200">$${p.price}</p>
                    <p class="text-primary-100 font-bold">${p.orders_count || 0} Orders</p>
                  </div>`;
            });
        } else {
            topProductsDiv.innerHTML = `<p class="text-text-200">No top products available.</p>`;
        }

    } catch (err) {
        notify("Failed to load dashboard data", "error");
    }
})();
</script>
{% endblock %}
