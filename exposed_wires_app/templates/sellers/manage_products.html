{% extends "layout.html" %}

{% block content %}
<div class="min-h-screen bg-bg-100 p-8">
  <div class="max-w-7xl mx-auto  shadow-xl rounded-2xl p-8">

    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-primary-100">Manage Products</h1>
      <a href="{% url 'add_product' %}" 
         class="bg-primary-100 hover:bg-primary-200 text-white px-5 py-2 rounded-lg cursor-pointer">
        ‚ûï Add Product
      </a>
    </div>

    <!-- Search -->
    <div class="mb-6">
      <input type="text" id="search-input" placeholder="Search products..." 
             class="w-full md:w-1/2 p-3 rounded-lg border border-bg-300 focus:outline-none focus:ring-2 focus:ring-primary-100">
    </div>

    <!-- Products Grid -->
    <div id="products-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
      <p class="text-text-200">Loading products...</p>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    const grid = document.getElementById("products-grid");
    const searchInput = document.getElementById("search-input");

    // load products from API helper
    const user = await get_data(get_User_url)
    const sellers = await get_data(get_Sellers_url+0)
    const seller = sellers.filter(s=>s.user == user.id)[0]
    let products = await get_data(get_Products_url+0) || [];
    products = products.filter(p=>p.seller == seller.id)

    function renderProducts(items) {
        grid.innerHTML = "";
        if (!items.length) {
            grid.innerHTML = `<p class="text-text-200 col-span-full text-center">No products found</p>`;
            return;
        }
        items.forEach(p => {
            // escape single quotes in name for safe inline usage (we'll prefer using id-only delete)
            grid.innerHTML += `
              <div class="bg-bg-200 rounded-lg shadow-lg p-4 flex flex-col">
                ${p.image ? `<img src="http://res.cloudinary.com/duxorzcjg/${p.image}" alt="${p.name}" class="w-full h-40 object-cover rounded-md mb-4">` : ""}
                <h3 class="font-semibold text-text-100 truncate">${p.name}</h3>
                <p class="text-sm text-text-200">${p.brand || ""}</p>
                <p class="text-primary-100 font-bold my-2">$${p.price}</p>
                ${p.discount > 0 ? `<p class="text-accent-200 text-sm font-semibold">-${p.discount}% Off</p>` : ""}
                <p class="text-text-200 text-sm">Stock: ${p.stock}</p>
                <p class="text-text-200 text-sm">Clicks: ${p.clicks}</p>
                <div class="mt-auto flex justify-between gap-2">
                  <a href="/products/edit/${p.id}/" 
                     class="bg-primary-200 hover:bg-primary-100 text-white px-3 py-1 rounded-lg text-sm">‚úèÔ∏è Edit</a>
                  <button onclick="window.deleteProduct(${p.id})" 
                          class="bg-accent-200 hover:bg-accent-100 text-white px-3 py-1 rounded-lg text-sm">üóë Delete</button>
                </div>
              </div>`;
        });
    }

    // initial render
    renderProducts(products);

    // search filter
    searchInput.addEventListener("input", e => {
        const term = e.target.value.toLowerCase();
        const filtered = products.filter(p => 
            (p.name || "").toString().toLowerCase().includes(term) || 
            (p.brand || "").toString().toLowerCase().includes(term)
        );
        renderProducts(filtered);
    });

    // Expose deleteProduct globally so inline onclick works
    window.deleteProduct = async function(id) {
        if (!id) return;

        // soft-confirm: first click requests confirmation via notification
        if (!window.deleteProduct.pending || window.deleteProduct.pending !== id) {
            window.deleteProduct.pending = id;
            if (typeof notify === 'function') {
                notify("Click Delete again within 3s to confirm.", "info");
            } else {
                console.log("Click Delete again within 3s to confirm.");
            }
            setTimeout(() => {
                if (window.deleteProduct.pending === id) window.deleteProduct.pending = null;
            }, 3000);
            return;
        }
        window.deleteProduct.pending = null;

        // perform DELETE directly (handles 204 and JSON responses)
        try {
          console.log(delete_Products_url)
            const res = await delete_data(delete_Products_url+id)
            products = products.filter(p => p.id !== id);
            renderProducts(products);
            notify('Deleted Successfully','success')

        } catch (err) {
            if (typeof notify === 'function') notify(err.message || "Delete failed", "error");
            else console.error(err);
        }
    };
});
</script>
{% endblock %}
