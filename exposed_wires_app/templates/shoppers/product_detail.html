{% extends "layout.html" %}

{% block content %}
<div class="min-h-screen bg-bg-100 py-10">
    <div class="max-w-5xl mx-auto bg-bg-100 shadow-xl rounded-2xl p-8">
        
        <!-- Product Header -->
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Image -->
            <div class="flex-shrink-0 w-full md:w-1/2">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}"
                         class="rounded-2xl shadow-md w-full object-cover">
                {% else %}
                    <div class="w-full h-64 bg-bg-200 rounded-2xl flex items-center justify-center text-text-200 text-lg">
                        No Image
                    </div>
                {% endif %}
            </div>

            <!-- Info -->
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-text-100 mb-3">{{ product.name }}</h1>
                
                {% if product.brand %}
                    <p class="text-text-200 mb-2">Brand: <span class="font-semibold">{{ product.brand }}</span></p>
                {% endif %}

                {% if product.category %}
                    <p class="text-text-200 mb-2">Category: <span class="font-semibold">{{ product.category.name }}</span></p>
                {% endif %}

                {% if product.condition %}
                    <p class="text-text-200 mb-2">Condition: <span class="font-semibold">{{ product.condition.name }}</span></p>
                {% endif %}

                <p class="text-2xl font-bold text-primary-200 mt-4">
                    ${{ price }}
                    {% if product.discount and product.discount > 0 %}
                        <span class="text-lg line-through text-text-200 ml-2">
                            ${{ product.price|floatformat:2|add:""|default:"" }}
                        </span>
                        <span class="ml-2 px-2 py-1 bg-accent-200 text-white rounded-lg text-sm">
                            -{{ product.discount }}%
                        </span>
                    {% endif %}
                </p>

                <p class="mt-2 text-text-200">Stock: 
                    {% if product.stock > 0 %}
                        <span class="text-priamry-100 font-semibold">{{ product.stock }}</span>
                    {% else %}
                        <span class="text-accent-1004 font-semibold">Out of stock</span>
                    {% endif %}
                </p>

                <div class="mt-6 flex gap-4">
                    <!-- Add to Cart Button -->
<button id="add-to-cart-btn"
        data-product-id="{{ product.id }}"
        class="bg-primary-200 hover:bg-primary-100 text-white px-6 py-2 rounded-lg">
    Add to Cart
</button>

<!-- Quantity Controls (hidden initially) -->
<div id="cart-quantity-controls" class="hidden flex items-center space-x-4 mt-4">
    <button id="decrease-qty" class="bg-gray-300 px-3 py-1 rounded">-</button>
    <span id="cart-quantity" class="font-bold text-lg">1</span>
    <button id="increase-qty" class="bg-gray-300 px-3 py-1 rounded">+</button>
</div>
                    <button class="bg-accent-200 hover:bg-accent-100 text-white px-6 py-3 rounded-lg shadow-md">
                        Buy Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Extra Info -->
        <div class="mt-10">
            <h2 class="text-xl font-semibold text-text-100 mb-4">Product Information</h2>
            <p class="text-text-200 leading-relaxed">
                {% if product.description %}
                    {{ product.description }}
                {% else %}
                    No additional details available for this product.
                {% endif %}
            </p>
        </div>

        <!-- Seller Info -->
        <div class="mt-10 bg-bg-200 p-6 rounded-xl shadow-md">
            <h3 class="text-lg font-semibold text-text-100 mb-3">Seller Information</h3>
            <p class="text-text-200"><span class="font-semibold">Seller:</span> {{ product.seller.user.username }}</p>
            {% if product.seller.store %}
                <p class="text-text-200"><span class="font-semibold">Store:</span> {{ product.seller.store.name }}</p>
            {% endif %}
        </div>

    </div>
</div>
{% endblock %}
{%block scripts%}
<script>
    (async () => {
    const addToCartBtn = document.getElementById("add-to-cart-btn");
    const quantityControls = document.getElementById("cart-quantity-controls");
    const qtyDisplay = document.getElementById("cart-quantity");

    if (!addToCartBtn) return; // Not on product detail page

    const productId = addToCartBtn.dataset.productId; 
    let cart = null;
    let cartItemId = null;
    let quantity = 1;
    let product = await get_data(get_Products_url+productId);
    try {
    const user = await get_data(get_User_url);
    if (!user) throw new Error("Not logged in");
    let shoppers = await get_data(get_Shoppers_url+0);
    let shopper = shoppers.find(s => s.user == user.id);
    if (!shopper) throw new Error("No shopper profile found");

    let carts = await get_data(get_Carts_url+0);
    cart = carts.find(c => c.shopper == shopper.id);
    if (!cart) throw new Error("No cart found for shopper");

    let cartItems = await get_data(get_CartItems_url +0);
    cartItems = cartItems.filter(item => item.cart == cart.id);

    // If this product is already in cart, preload values
    const existingItem = cartItems.find(item => item.product == productId);
    if (existingItem) {
        cartItemId = existingItem.id;
        quantity = existingItem.quantity;
        qtyDisplay.textContent = quantity;
        addToCartBtn.classList.add("hidden");
        quantityControls.classList.remove("hidden");
    }
        
    } catch (error) {
        setTimeout(() => {
            openLoginModal();
        }, 1000);
    }
    
   addToCartBtn.addEventListener("click", async function () {
    let cartItemData = {
        cart: cart.id,
        product: productId,
        quantity: 1,
    };

    try {
        // If item already exists, just update quantity
        if (existingItem) {
            cartItemId = existingItem.id;
            quantity = existingItem.quantity + 1;

            const data = await patch_data(patch_CartItems_url + cartItemId, { quantity });

            if (data) {
                updateCartUI();
            }
            return;
        }

        // Create a new cart item
        const postCartItemsData = await post_data(post_CartItems_url, cartItemData);

        if (postCartItemsData && (postCartItemsData.id || postCartItemsData.pk)) {
            cartItemId = postCartItemsData.id || postCartItemsData.pk;
            updateCartUI();
        } else {
            notify("Failed to add product to cart", "error");
        }
    } catch (err) {
        console.error("Add to cart error:", err);
        notify("Error adding to cart", "error");
    }
});

// âœ… Extracted UI updater (no duplication)
function updateCartUI() {
    set_cart();
    notify("Added to cart", "success");
    qtyDisplay.textContent = quantity;
    addToCartBtn.classList.add("hidden");
    quantityControls.classList.remove("hidden");
}

    document.getElementById("increase-qty")?.addEventListener("click", async function (){
        if (parseInt(product.stock) <= quantity) {
            notify("No more stock available", "error");
            return;
        }
        quantity++;
        try{
            const data = await patch_data(patch_CartItems_url+cartItemId, { quantity });
            
        }
        catch(err){
            
         setTimeout(()=>{
            set_cart()
            notify("Quantity increased", "success");
            qtyDisplay.textContent = quantity;
        },0)
    }
    });

    document.getElementById("decrease-qty")?.addEventListener("click", async () => {
        if (quantity > 1) {
            quantity--;
            try{
            const data = await patch_data(patch_CartItems_url+cartItemId, { quantity });
            
                }
            catch(err){
                    
                setTimeout(()=>{
                    set_cart()
                    notify("Quantity decreased", "success");
                    qtyDisplay.textContent = quantity;
                    addToCartBtn.classList.add("hidden");
                    quantityControls.classList.remove("hidden");
                },0)
            }
            return
        } 
        try{
        const data = await delete_data(delete_CartItems_url+cartItemId);
        }catch(err){

            
    setTimeout(()=>{
        notify("Item removed from cart", "info");
        quantity = 1;
        qtyDisplay.textContent = quantity;
        addToCartBtn.classList.remove("hidden");
        quantityControls.classList.add("hidden");
        set_cart()  
    },0)

            
    }
        
            
        
    });
})();


</script>
{%endblock%}