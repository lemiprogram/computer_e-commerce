{% extends "layout.html" %}

{% block admin_content %}
<div class="p-6 bg-bg-100 min-h-screen">

  <!-- Page Title -->
  <h1 class="text-3xl font-bold text-primary-100 mb-6">Manage Stores</h1>

  <!-- Search Bar -->
  <div class="mb-6">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search stores by name or city..." 
      class="w-full md:w-1/2 p-3 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-200"
      onkeyup="filterStores()"
    >
  </div>

  <!-- Notifications -->
  <div id="notifications" class="fixed top-4 right-4 space-y-3 z-50"></div>

  <!-- Stores Grid -->
  <div id="storesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Store cards will load here -->
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  let storesData = [];

  // ðŸ”” Notification system
  function showNotification(message, type="info") {
    const container = document.getElementById("notifications");
    const div = document.createElement("div");

    const colors = {
      success: "bg-green-500",
      error: "bg-red-500",
      info: "bg-primary-200"
    };

    div.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow flex justify-between items-center animate-fade-in`;
    div.innerHTML = `
      <span>${message}</span>
      <button onclick="this.parentElement.remove()" class="ml-4 font-bold">Ã—</button>
    `;

    container.appendChild(div);

    setTimeout(() => div.remove(), 4000);
  }

  // Fetch stores
  async function fetchStores() {
    storesData = await get_data(get_Stores_url+0);
    renderStores(storesData);
  }

  // Render store cards
  function renderStores(data) {
    const grid = document.getElementById("storesGrid");
    grid.innerHTML = "";

    if (data.length === 0) {
      grid.innerHTML = `<p class="col-span-full text-text-200">No stores found.</p>`;
      return;
    }

    data.forEach(store => {
      const card = document.createElement("div");
      card.className = "bg-bg-100 rounded-xl shadow-lg p-6 flex flex-col items-center text-center";

      card.innerHTML = `
        ${ store.profile_image
          ? `<img src="${store.profile_image}" alt="${store.name}" class="w-20 h-20 rounded-full object-cover mb-4">`
          : `<div class="w-20 h-20 rounded-full bg-bg-300 flex items-center justify-center text-xl font-bold text-white mb-4">
               ${store.name.charAt(0).toUpperCase()}
             </div>`
        }

        <h2 class="text-lg font-semibold text-text-100">${store.name}</h2>
        <p class="text-sm text-text-200">${store.city || "Unknown City"}</p>
        <p class="text-sm mt-2">${store.phone || ""}</p>
        <p class="text-sm mt-2">${store.website ? `<a href="${store.website}" class="text-primary-200 underline">Website</a>` : ""}</p>

        <p class="mt-2 text-sm">
          Status: 
          <span class="font-medium ${store.is_active ? 'text-green-600' : 'text-red-600'}">
            ${store.is_active ? "Active" : "Inactive"}
          </span>
        </p>
        <p class="mt-1 text-sm">
          Verified: 
          <span class="font-medium ${store.verified ? 'text-green-600' : 'text-red-600'}">
            ${store.verified ? "Yes" : "No"}
          </span>
        </p>

        <!-- Actions -->
        <div class="mt-4 flex flex-wrap gap-2 justify-center">
          <a href="/stores/${store.id}" class="px-4 py-2 bg-primary-100 text-white rounded-lg hover:bg-primary-200">
            View
          </a>
          <button onclick="deleteStore(${store.id}, '${store.name}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
            Delete
          </button>
          <button onclick="toggleActive(${store.id}, ${store.is_active})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            ${store.is_active ? "Deactivate" : "Activate"}
          </button>
          <button onclick="toggleVerified(${store.id}, ${store.verified})" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
            ${store.verified ? "Unverify" : "Verify"}
          </button>
        </div>
      `;

      grid.appendChild(card);
    });
  }

  // Search filter
  function filterStores() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const filtered = storesData.filter(s =>
      s.name.toLowerCase().includes(input) ||
      (s.city && s.city.toLowerCase().includes(input))
    );
    renderStores(filtered);
  }

  // Delete store
  async function deleteStore(id, name) {
    if (!deleteStore.pending || deleteStore.pending !== id) {
      deleteStore.pending = id;
      showNotification(`Click delete again to confirm removing "${name}".`, "info");
      setTimeout(() => { if (deleteStore.pending === id) deleteStore.pending = null; }, 3000);
      return;
    }
    deleteStore.pending = null;

    const res = await delete_data(delete_Stores_url+id);
    if (res.ok) {
      storesData = storesData.filter(s => s.id !== id);
      renderStores(storesData);
      showNotification(`Store "${name}" deleted successfully.`, "success");
    } else {
      showNotification(`Failed to delete store "${name}".`, "error");
    }
  }

  // Toggle Active
  async function toggleActive(id, current) {
    const res = await patch_data(patch_Stores_url+id, { is_active: !current });
    if (res.ok) {
      const store = storesData.find(s => s.id === id);
      store.is_active = !current;
      renderStores(storesData);
      showNotification(`Store "${store.name}" ${store.is_active ? "activated" : "deactivated"}.`, "success");
    } else {
      showNotification("Failed to update store status.", "error");
    }
  }

  // Toggle Verified
  async function toggleVerified(id, current) {
    const res = await patch_data(patch_Stores_url+id, { verified: !current });
    if (res.ok) {
      const store = storesData.find(s => s.id === id);
      store.verified = !current;
      renderStores(storesData);
      showNotification(`Store "${store.name}" ${store.verified ? "verified" : "unverified"}.`, "success");
    } else {
      showNotification("Failed to update store verification.", "error");
    }
  }

  // Init load
  fetchStores();
</script>

<style>
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>
{% endblock %}
